{ pkgs, lib, ... }:
{
  # lspci -nn 并设置启动内核参数
  # boot.kernelParams = [ "vfio-pci.ids=10de:26b1,10de:2684" ];
  # 然后给用户访问权限
  # services.udev.extraRules = ''
  #     SUBSYSTEM=="kvmfr", OWNER="user", GROUP="kvm", MODE="0660"
  # '';

  boot = {
    initrd.kernelModules = lib.mkBefore [
      "vfio_pci"
      "vfio"
      "vfio_iommu_type1"
    ]; # 确保 vfio 模块早于实际驱动加载
    kernelModules = [ "kvmfr" ];
    extraModulePackages = [ config.boot.kernelPackages.kvmfr ];
    extraModprobeConfig = ''
      options kvmfr static_size_mb=64
      options kvm_intel nested=1
    '';
  };

  environment.systemPackages = with pkgs; [ looking-glass-client ];
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⣶⣿⣿⣿⣷⣶⣶⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⣿⣿⠟⠋⠉⠉⠉⠉⠉⠙⠛⠻⠿⣷⣦⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠙⢻⣷⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣤⣤⣤⣤⣈⡙⠿⣶⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  # ⢀⣤⣶⣶⣶⣦⣤⣴⣶⣶⣶⣶⡶⠶⠶⠾⠿⠿⠿⢿⣶⣦⣄⡀⠀⠀⠈⠉⠉⠉⠙⠛⠛⠛⠓⠒⠙⠻⣦⣀⠀⠀⠀⠀⠀⠀⠀
  # ⣾⣿⢁⣀⣈⠉⠻⢿⣿⣿⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠛⢿⣷⣤⡀⠀⠀⠀⠀⠀⢿⣆⡀⠀⠀⠀⠈⠙⢷⣄⠀⠀⠀⠀⠀
  # ⢹⣿⠛⠻⣿⡛⢓⡂⠙⢮⢻⣷⡄⠀⠀⠀⠀⠀⠀⠀⢀⣠⣴⣿⣿⣿⣿⣶⣄⠀⠀⠀⠀⠙⠛⠦⣄⡀⠀⠀⠀⠙⢷⣄⠀⠀⠀
  # ⠀⢻⣷⡀⠘⢿⣿⠇⠀⣸⠳⣿⣿⣆⠀⠀⠀⢀⣠⣶⡿⠿⣿⣍⡉⠉⠉⠙⢿⣷⡄⠀⠀⠀⠀⠀⠀⠈⠁⠒⠀⠀⠀⠙⠃⠀⠀
  # ⠀⠈⢿⣷⣄⢮⣯⣤⡶⠏⠀⢿⣿⣿⣀⣀⣴⣾⠿⠋⠁⠀⠙⠻⢷⣦⣄⣀⠈⠻⣷⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  # ⠀⠀⠀⠙⢿⣷⣬⡙⠛⠒⠂⣸⣿⣿⣿⠟⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠀⠙⢿⣷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
  # ⠀⠀⠀⠀⠀⠈⠛⠿⢿⣶⣿⡿⠟⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣿⣆⠀⢀⣀⣀⣀⠀⠀⠀⠀⠀⠀⠀
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢿⡿⠿⠿⠿⠛⠀⠀⠀⠀⠀⠀⠀
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⡀⠀⠀⠀⠀⠀⠀⢀⣀
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠿⠟⡛⠛⠀⠀⠀⠀⠀⢀⣼⡟
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢻⣧⡉⠛⠛⠃⢀⣠⣤⣾⠟⠉⠀
  # ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣿⣿⣿⣿⡿⠟⠋⠀⠀⠀⠀
}
